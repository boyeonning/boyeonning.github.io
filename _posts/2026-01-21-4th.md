---
layout: post
title: "SQLAlchemy 완벽 가이드 - Connection, Session, ORM 비교"
---

## 1. 데이터베이스 연결

### 기본 연결 설정
```python
from sqlalchemy import create_engine, text

DATABASE_URI = 'mysql+pymysql://username:password@localhost:3306/database'
engine = create_engine(DATABASE_URI)
```

### 드라이버 선택
| 드라이버 | URI 형식 | 특징 |
|---|---|---|
| pymysql | `mysql+pymysql://` | 순수 Python, 설치 쉬움 |
| mysqlclient | `mysql+mysqldb://` | C 기반, 더 빠름 |

---

## 2. Python DB Driver vs SQLAlchemy

### 순수 드라이버 (mysql-connector)
```python
import mysql.connector

connection = mysql.connector.connect(
    host='localhost',
    user='user',
    password='password',
    database='database'
)
cursor = connection.cursor()
cursor.execute("SELECT * FROM users")
rows = cursor.fetchall()
cursor.close()
connection.close()
```

### SQLAlchemy
```python
from sqlalchemy import create_engine, text

engine = create_engine("mysql+pymysql://user:password@localhost:3306/db")
with engine.connect() as conn:
    result = conn.execute(text("SELECT * FROM users"))
    for row in result:
        print(row)
```

### 차이점 비교

| | 순수 드라이버 | SQLAlchemy |
|---|---|---|
| 비유 | 한국어만 하는 사람 | 통역사 (여러 언어 가능) |
| DB 지원 | MySQL 전용 | MySQL, PostgreSQL, SQLite 등 |
| DB 변경 시 | 코드 전체 수정 | URI만 변경 |
| 연결 관리 | 직접 관리 | 자동 관리 (연결 풀) |

**핵심:** SQLAlchemy는 통역사처럼 여러 DB와 소통 가능. 나중에 DB를 바꿔도 코드 거의 안 고쳐도 됨.

---

## 3. cursor vs engine

### cursor (드라이버)
**= 일회용 심부름꾼**
```python
cursor = connection.cursor()  # 심부름꾼 생성
cursor.execute("SELECT ...")  # 일 시킴
cursor.fetchall()             # 결과 받음
cursor.close()                # 해고
```

### engine (SQLAlchemy)
**= 연결 관리 매니저**
```python
engine = create_engine(...)   # 매니저 한 번만 생성
with engine.connect() as conn:
    conn.execute(...)         # 필요할 때마다 자동 관리
```

| cursor | engine |
|---|---|
| 일용직 알바 | 정규직 매니저 |
| 매번 고용/해고 | 한 번 고용, 계속 일함 |
| 한 가지 일만 | 여러 일 동시에 관리 |
| 직접 관리 | 알아서 관리 |

---

## 4. Connection vs Session

SQLAlchemy에서 DB에 접근하는 두 가지 방식이 있다.

### Connection 방식 (Raw SQL)
```python
with engine.connect() as conn:
    result = conn.execute(text("SELECT * FROM blog"))
    for row in result:
        print(row)
```

**적합한 경우:**
- 복잡한 JOIN, 서브쿼리, 집계 함수
- 대량 데이터 일괄 처리 (bulk insert/update)
- DB 고유 기능 사용
- 성능이 중요한 경우

### Session 방식 (ORM)
```python
from sqlalchemy.orm import Session

with Session(engine) as session:
    blogs = session.query(Blog).all()
    for blog in blogs:
        print(blog.title)
```

**적합한 경우:**
- CRUD 작업 (객체 단위 생성/수정/삭제)
- 관계 있는 테이블 다룰 때 (1:N, N:M)
- 비즈니스 로직과 데이터 함께 관리
- 코드 가독성, 유지보수 중요할 때

### 비교 요약

| | Connection | Session (ORM) |
|---|---|---|
| 문법 | SQL 직접 작성 | Python 객체 |
| 성능 | 빠름 | 약간 느림 |
| 편의성 | 낮음 | 높음 |
| 용도 | 복잡한 쿼리, 대량 처리 | 일반적인 CRUD |

**실무 팁:** ORM을 기본으로 쓰고, 복잡하거나 성능이 필요한 쿼리만 Raw SQL로 작성

---

## 5. DB Session vs SQLAlchemy Session

### 데이터베이스 Session
- 클라이언트가 DB 서버에 연결한 **물리적 연결 상태**
- 연결부터 종료까지의 기간
- 연결 풀에서 관리되는 connection 단위

### SQLAlchemy Session
- **ORM 레벨의 추상화 계층**
- 객체의 변경사항을 추적하고 트랜잭션을 관리
- 내부적으로 DB connection을 사용하지만 1:1 매핑은 아님

| | DB Session | SQLAlchemy Session |
|---|---|---|
| 역할 | 물리적 연결 | ORM 작업 단위 |
| 용도 | raw SQL 실행 | 객체 CRUD |
| 관리 | `engine.connect()` | `Session(engine)` |

---

## 6. ORM 모델 정의

```python
from sqlalchemy import Column, Integer, String, DateTime
from sqlalchemy.orm import declarative_base

Base = declarative_base()

class Blog(Base):
    __tablename__ = 'blog'

    id = Column(Integer, primary_key=True)
    title = Column(String(200), nullable=False)
    author = Column(String(100), nullable=False)
    content = Column(String(4000), nullable=False)
    image_loc = Column(String(300), nullable=True)
    modified_dt = Column(DateTime, nullable=False)
```

### 테이블 컬럼 정보 조회
```sql
-- MySQL
DESCRIBE blog;
SHOW COLUMNS FROM blog;
```

```python
# SQLAlchemy
from sqlalchemy import inspect

inspector = inspect(engine)
columns = inspector.get_columns('blog')
for col in columns:
    print(col)
```

---

## 7. CRUD 예제

### 조회 (Read)
```python
with Session(engine) as session:
    # 전체 조회
    blogs = session.query(Blog).all()

    # 조건 조회
    blog = session.query(Blog).filter(Blog.id == 1).first()
```

### 삽입 (Create)
```python
from datetime import datetime

with Session(engine) as session:
    new_blog = Blog(
        title="새로운 글",
        author="작성자",
        content="내용입니다.",
        modified_dt=datetime.now()
    )
    session.add(new_blog)
    session.commit()

    print(f"추가됨! ID: {new_blog.id}")
```

### 여러 개 삽입
```python
with Session(engine) as session:
    session.add_all([blog1, blog2, blog3])
    session.commit()
```

### 수정 (Update)
```python
with Session(engine) as session:
    blog = session.query(Blog).filter(Blog.id == 1).first()
    blog.title = "수정된 제목"
    session.commit()
```

### 삭제 (Delete)
```python
with Session(engine) as session:
    blog = session.query(Blog).filter(Blog.id == 1).first()
    session.delete(blog)
    session.commit()
```

---

## 8. 리소스 정리

### with 문 사용 (권장)
```python
with engine.connect() as conn:
    result = conn.execute(text(sql))
    for row in result:
        print(row)
# 자동으로 connection, result 정리됨
```

### 수동 정리
```python
conn = engine.connect()
result = conn.execute(text(sql))
for row in result:
    print(row)
result.close()  # 필요
conn.close()    # 필요
```

**권장:** `with` 문을 사용하면 자동으로 리소스가 정리되므로 `close()`가 필요 없음

---

## 참고

- [SQLAlchemy 공식 문서](https://docs.sqlalchemy.org/)
- [SQLAlchemy ORM Tutorial](https://docs.sqlalchemy.org/en/20/orm/tutorial.html)
