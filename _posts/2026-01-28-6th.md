---
layout: post
title: "SQLAlchemy pool_recycle 쉽게 이해하기"
---

# SQLAlchemy `pool_recycle` 쉽게 이해하기

## 한 줄 요약

`pool_recycle`은 **DB 연결을 너무 오래 쓰지 않도록 자동으로 새로 만들어주는 설정**이다.

> 몇 초 이상 된 연결은 버리고 새 연결을 사용한다.

---

## 왜 `pool_recycle`이 필요할까?

MySQL, MariaDB 같은 DB는 일정 시간 동안 사용되지 않은 연결을 **서버 쪽에서 자동으로 끊어버린다**.

문제는 SQLAlchemy가 그 사실을 모르고,

> “이 연결 아직 살아있겠지?”

하고 다시 쓰려다 에러가 나는 것 😱

대표적인 에러:

```
MySQL server has gone away
Lost connection to MySQL server during query
```

이 문제를 예방하기 위해 사용하는 게 바로 `pool_recycle`이다.

---

## `pool_recycle` 동작 방식

```text
1. DB 연결 생성
2. 커넥션 풀(pool)에 저장
3. 다시 사용하려고 꺼낼 때
   ├─ 연결 생성 후 경과 시간이 pool_recycle 초 이상이면
   │   → 기존 연결 폐기 ❌
   │   → 새 연결 생성 ✅
   └─ 아직 시간이 안 지났으면 그대로 사용
```

즉, **문제가 생기기 전에 미리 연결을 갈아끼우는 방식**이다.

---

## 사용 예시

```python
from sqlalchemy import create_engine

engine = create_engine(
    "mysql+pymysql://user:password@host/db",
    pool_recycle=3600
)
```

### 의미

* DB 연결을 **최대 3600초 (1시간)** 까지만 유지
* 1시간이 지난 연결은 자동으로 재연결

---

## 보통 얼마로 설정할까?

DB의 `wait_timeout` 값보다 **조금 짧게** 설정하는 게 정석이다.

일반적인 추천 값:

| 환경              | 추천 값 (초)    |
| --------------- | ----------- |
| MySQL / MariaDB | 1800 ~ 3600 |
| AWS RDS MySQL   | 300 ~ 1800  |
| 잘 모르겠을 때        | **1800**    |

---

## `pool_pre_ping`과의 차이

헷갈리기 쉬운 옵션 하나 더 👇

### `pool_pre_ping`

* 쿼리 실행 **직전에**
* `SELECT 1` 같은 ping으로
* 연결이 살아있는지 확인

### 비교 정리

| 옵션            | 기준 | 특징            |
| ------------- | -- | ------------- |
| pool_recycle  | 시간 | 오래된 연결을 미리 교체 |
| pool_pre_ping | 상태 | 죽은 연결만 감지     |

### 실무 추천 설정

```python
create_engine(
    url,
    pool_recycle=1800,
    pool_pre_ping=True
)
```

➡️ **안정성 최우선 조합**

---

## 한 줄 비유로 이해하기 🥛

* DB 연결 = 우유
* `pool_recycle=1800` =

> “우유 만든 지 30분 넘었으면
> 마시기 전에 버리고 새로 꺼내자”

---

## 언제 특히 중요할까?

* FastAPI / Flask 같은 **웹 서버**
* **서버리스 환경 (Lambda, Cloud Functions)**
* 트래픽이 들쭉날쭉한 서비스

이런 환경에서는 거의 필수 옵션이다.

---

## 정리

* `pool_recycle`은 **DB 연결 수명 제한 옵션**
* 오래된 연결로 인한 오류를 사전에 차단
* MySQL 계열에서는 사실상 필수
* `pool_pre_ping`과 함께 쓰면 가장 안전

---

