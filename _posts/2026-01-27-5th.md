---
layout: post
title: "Python @contextmanagerì™€ yield ì™„ë²½ ì´í•´í•˜ê¸°"
---

# Python @contextmanagerì™€ yield ì™„ë²½ ì´í•´í•˜ê¸°

## ğŸ¤” contextmanagerê°€ ë­ê¸¸ë˜?

íŒŒì¼ì„ ì—´ê³  ë‹«ê±°ë‚˜, DB ì—°ê²°ì„ ê´€ë¦¬í•  ë•Œ `with` ë¬¸ì„ ì‚¬ìš©í•˜ì£ ? 
ì´ê±¸ **ì‰½ê²Œ** ë§Œë“¤ì–´ì£¼ëŠ” ê²Œ `@contextmanager`ì…ë‹ˆë‹¤!

---

## ğŸ“š ë¹„êµ: yield ì—†ì´ vs yield ì‚¬ìš©

### âŒ ë°©ë²• 1: yield ì—†ì´ (í´ë˜ìŠ¤ë¡œ ë§Œë“¤ê¸°)
```python
class FileManager:
    def __init__(self, filename):
        self.filename = filename
        
    def __enter__(self):
        print("íŒŒì¼ ì—´ê¸°")
        self.file = open(self.filename, 'w')
        return self.file
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        print("íŒŒì¼ ë‹«ê¸°")
        self.file.close()

# ì‚¬ìš©
with FileManager('test.txt') as f:
    f.write('ì•ˆë…•í•˜ì„¸ìš”')
```

**ë‹¨ì :**
- `__enter__`ì™€ `__exit__` ë‘ ê°œ ë©”ì„œë“œë¥¼ ë”°ë¡œ ì‘ì„±í•´ì•¼ í•¨
- ì½”ë“œê°€ ê¸¸ê³  ë³µì¡í•¨
- í´ë˜ìŠ¤ êµ¬ì¡° ì´í•´ í•„ìš”

---

### âœ… ë°©ë²• 2: @contextmanager + yield (í•¨ìˆ˜ë¡œ ê°„ë‹¨íˆ!)
```python
from contextlib import contextmanager

@contextmanager
def file_manager(filename):
    print("íŒŒì¼ ì—´ê¸°")
    f = open(filename, 'w')
    
    yield f  # â† ì—¬ê¸°ì„œ ë©ˆì¶¤! with ë¸”ë¡ìœ¼ë¡œ f ì „ë‹¬
    
    print("íŒŒì¼ ë‹«ê¸°")
    f.close()

# ì‚¬ìš© (ë˜‘ê°™ìŒ!)
with file_manager('test.txt') as f:
    f.write('ì•ˆë…•í•˜ì„¸ìš”')
```

**ì¥ì :**
- í•¨ìˆ˜ í•˜ë‚˜ë¡œ ë!
- ì½”ë“œê°€ ì§§ê³  ì½ê¸° ì‰¬ì›€
- yield ê¸°ì¤€ìœ¼ë¡œ ì „/í›„ ì‘ì—…ì´ ëª…í™•íˆ êµ¬ë¶„ë¨

---

## ğŸ¯ í•µì‹¬ ì°¨ì´ì 

| êµ¬ë¶„ | yield ì—†ì´ (í´ë˜ìŠ¤) | @contextmanager + yield |
|------|---------------------|--------------------------|
| **ì½”ë“œëŸ‰** | ê¸¸ê³  ë³µì¡ | ì§§ê³  ê°„ë‹¨ |
| **êµ¬ì¡°** | í´ë˜ìŠ¤ + 2ê°œ ë©”ì„œë“œ | í•¨ìˆ˜ 1ê°œ |
| **êµ¬ë¶„** | `__enter__`ì™€ `__exit__` ë¶„ë¦¬ | yield ê¸°ì¤€ìœ¼ë¡œ ìœ„/ì•„ë˜ |
| **ë‚œì´ë„** | ì¤‘ê¸‰ | ì´ˆê¸‰ |

---

## ğŸ” yieldê°€ ì •í™•íˆ í•˜ëŠ” ì¼
```python
@contextmanager
def my_context():
    print("1. ì¤€ë¹„ ì‘ì—… (before)")
    
    yield "ë°˜í™˜ê°’"  # â† with ë¸”ë¡ì´ ì‹¤í–‰ë˜ëŠ” ë™ì•ˆ ì—¬ê¸°ì„œ ëŒ€ê¸°!
    
    print("3. ì •ë¦¬ ì‘ì—… (after)")

# ì‚¬ìš©
with my_context() as value:
    print(f"2. ì‘ì—… ì¤‘: {value}")
```

**ì‹¤í–‰ ìˆœì„œ:**
```
1. ì¤€ë¹„ ì‘ì—… (before)
2. ì‘ì—… ì¤‘: ë°˜í™˜ê°’
3. ì •ë¦¬ ì‘ì—… (after)
```

**ë™ì‘ ì›ë¦¬:**
1. `yield` ì „ê¹Œì§€ ì‹¤í–‰ (ì¤€ë¹„ ì‘ì—…)
2. `yield`ì—ì„œ ë©ˆì¶”ê³  ê°’ì„ `with` ë¸”ë¡ì— ì „ë‹¬
3. `with` ë¸”ë¡ ë‚´ë¶€ ì½”ë“œ ì‹¤í–‰
4. `with` ë¸”ë¡ ì¢…ë£Œ í›„ `yield` ì´í›„ ì½”ë“œ ì‹¤í–‰ (ì •ë¦¬ ì‘ì—…)

---

## ğŸ’¡ ì‹¤ì „ ì˜ˆì œ

### ì˜ˆì œ 1: ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜ ê´€ë¦¬
```python
from contextlib import contextmanager

@contextmanager
def db_session():
    # ì—°ê²° ì—´ê¸°
    session = create_session()
    
    try:
        yield session  # ì‘ì—…í•˜ëŠ” ë™ì•ˆ ëŒ€ê¸°
        session.commit()  # ì„±ê³µí•˜ë©´ ì»¤ë°‹
    except:
        session.rollback()  # ì—ëŸ¬ë‚˜ë©´ ë¡¤ë°±
        raise
    finally:
        session.close()  # ë¬´ì¡°ê±´ ë‹«ê¸°

# ì‚¬ìš©
with db_session() as session:
    session.add(User(name='í™ê¸¸ë™'))
    session.add(User(name='ê¹€ì² ìˆ˜'))
    # ìë™ìœ¼ë¡œ commit/close ë¨!
```

### ì˜ˆì œ 2: ì‹œê°„ ì¸¡ì •
```python
import time
from contextlib import contextmanager

@contextmanager
def timer(name):
    print(f"[{name}] ì‹œì‘")
    start = time.time()
    
    yield
    
    elapsed = time.time() - start
    print(f"[{name}] ì™„ë£Œ: {elapsed:.2f}ì´ˆ")

# ì‚¬ìš©
with timer("ë°ì´í„° ì²˜ë¦¬"):
    # ë¬´ê±°ìš´ ì‘ì—…
    time.sleep(2)
```

**ì¶œë ¥:**
```
[ë°ì´í„° ì²˜ë¦¬] ì‹œì‘
[ë°ì´í„° ì²˜ë¦¬] ì™„ë£Œ: 2.00ì´ˆ
```

### ì˜ˆì œ 3: ì„ì‹œ ë””ë ‰í† ë¦¬ ë³€ê²½
```python
import os
from contextlib import contextmanager

@contextmanager
def change_dir(path):
    original = os.getcwd()
    os.chdir(path)
    print(f"ë””ë ‰í† ë¦¬ ë³€ê²½: {path}")
    
    yield
    
    os.chdir(original)
    print(f"ë””ë ‰í† ë¦¬ ë³µì›: {original}")

# ì‚¬ìš©
with change_dir('/tmp'):
    print(f"í˜„ì¬ ìœ„ì¹˜: {os.getcwd()}")
    # /tmpì—ì„œ ì‘ì—…
# ìë™ìœ¼ë¡œ ì›ë˜ ë””ë ‰í† ë¦¬ë¡œ ë³µì›ë¨
```

---

## ğŸ“ ì •ë¦¬

- **@contextmanager + yield**: í´ë˜ìŠ¤ ì—†ì´ í•¨ìˆ˜ë§Œìœ¼ë¡œ context manager ë§Œë“¤ê¸°
- **yield ì „**: ì¤€ë¹„ ì‘ì—… (ë¦¬ì†ŒìŠ¤ íšë“)
- **yield**: ê°’ ì „ë‹¬ & ëŒ€ê¸°
- **yield í›„**: ì •ë¦¬ ì‘ì—… (ë¦¬ì†ŒìŠ¤ í•´ì œ)

**ì–¸ì œ ì‚¬ìš©í•˜ë‚˜ìš”?**
- íŒŒì¼ ì—´ê¸°/ë‹«ê¸°
- DB ì—°ê²° ê´€ë¦¬
- ë½(Lock) íšë“/í•´ì œ
- ì„ì‹œ ì„¤ì • ë³€ê²½/ë³µì›
- ì‹œê°„ ì¸¡ì •
- ë¡œê¹… ë²”ìœ„ ì§€ì •

---

## ğŸ“Œ ê¸°ì–µí•˜ì„¸ìš”!

> `@contextmanager + yield` = ë³µì¡í•œ í´ë˜ìŠ¤ ëŒ€ì‹  **ê°„ë‹¨í•œ í•¨ìˆ˜ í•˜ë‚˜**ë¡œ with ë¬¸ ë§Œë“¤ê¸°! ğŸš€
```python
# ì´ê²ƒë§Œ ê¸°ì–µí•˜ì„¸ìš”!
@contextmanager
def my_manager():
    # ì‹œì‘ ì‘ì—…
    yield ê°’
    # ì¢…ë£Œ ì‘ì—…
```

---

*ì‘ì„±ì¼: 2025ë…„ 1ì›”*
